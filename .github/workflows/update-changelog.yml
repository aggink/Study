name: Update Changelog

on:
  push:
    branches:
      - master

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Загружаем полную историю коммитов

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

      - name: Extract PR commits and filter
        id: pr_commits
        run: |
          DATE=$(date +'%Y-%m-%d')
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # Получаем список всех коммитов в PR
          COMMITS=$(git log --pretty=format:"%h %s (Автор: %an)" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          # Фильтруем коммиты с [Private]
          FILTERED_COMMITS=$(echo "$COMMITS" | grep -v '\[Private\]')

          # Если после фильтрации список пуст - пропускаем обновление CHANGELOG
          if [ -z "$FILTERED_COMMITS" ]; then
            echo "All commits contain [Private], skip updating CHANGELOG."
            exit 0
          fi

          # Формируем строку для CHANGELOG
          echo "" >> CHANGELOG.md  # Добавляем пустую строку перед новой записью
          echo "$DATE - PR #${{ github.event.pull_request.number }} от @${AUTHOR}" >> CHANGELOG.md
          echo "$FILTERED_COMMITS" >> CHANGELOG.md

      - name: Commit and push changes
        run: |
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG with latest PR commits"
          git push